// FILE:   CableMonitor.c
//
// DESCRIPTION:
//
//    Channel A0 is converted and logged in a buffer (SampleTable)
//    Using sequencer1 in sequencer override mode. Sequencer is Sequential mode
//    with sample rate of 100Hz.
//
//       Watch Variables:
//          SampleTable - Log of converted values.
//          GPIO34      - Toggles on every ADC sequencer flag
//
//###########################################################################

#include "DSP28x_Project.h"     // Device Headerfile and Examples Include File
#include "CableMonitoring.h"	// Project variable structure include file
#include "ADCsetup.h"			// Definitions for ADC from original file

// for FFT function input
#pragma DATA_SECTION(SampleTable,"INBUF");

// Global variables
   float32 SampleTable[DATA_LENGTH] = {31112,32226,32300,32114,31966,31743,31372,31149,32709,32374,32671,31706,31298,28996,28402,26954,25580,25023,24652,24466,24726,25209,25209,24726,25580,25172,24206,23427,23538,22944,21273,21162,19491,18452,16967,16150,14962,15519,16150,16558,18786,19974,20085,22202,23167,25135,25060,26286,26026,24615,23427,22090,19640,17375,16410,15036,13922,14590,15370,17004,18489,20382,21496,22016,23538,23167,22907,22164,21756,19825,19268,18080,15964,14293,13848,13996,14071,15110,16558,16632,18452,19306,20122,20716,21645,21459,21051,21236,20160,19640,19009,17895,16521,15296,16558,16929,18749,21310,23278,26397,28996,31001,31855,31706,31520,30072,29441,28439,27288,24615,23315,21533,19454,18934,17821,17969,18118,19231,19825,20754,22127,23093,23278,23204,22721,21570,20605,20197,18415,18155,17412,16521,16707,16818,17301,16855,17598,16929,16261,15147,14516,14182,13254,14145,14256,15927,17672,18340,18749,18934,20716,21162,22610,24095,25172,25877,27214,28179,28773,29256,30444,29404,28476,28773,29590,28996,29887,29998,29478,30035,29330,28476,27919,28402,28328,27585,27139,26211,25023,24466,23501,23241,22387,23093,23390,23872,24021,24206,24429,24021,24206,23501,23167,22461,20828,19751,18823,17969,16929,17115,16967,17969,20122,21570,23649,25060,26880,27585,28290,28587,27845,26842,25914,24392,21942,20716,18934,16298,15407,14293,14256,14182,15519,17598,18712,20828,21570,21830,21236,20048,18786,16373,15593,13551,12548,11917,11472,11323,10135,11063,10989,11323,12734,13588,14776,16261,17078,17041,17895,18192,18118,17338,16150,15036,14034,14479,14999,15073,16484,18415,20939,23649,26657,28736,29293,30184,30741,30926,29330,28662,26286,24763,23315,20642,19491,18563,17932,17821,18526,20531,21088,22833,24986,25729,25877,25432,26211,24615,24800,23947,22164,20976,20642,19268,19231,19380,18971,16781,15370,15110,14516,14293,14405,13625,12623,12845,12623,12029,12623,12957,12994,13699,14962,14516,15259,16261,17821,18377,19306,19863,19009,20122,20568,20791,20160,21385,21645,22239,23167,23093,22276,21682,20716,19788,18266,18674,18080,17969,19009,18749,18489,17969,17932,16113,15964,15370,15296,15853,17152,18526,18823,19417,19157,18415,17821,17449,15741,14665,13811,13180,13477,14405,14516,14887,15741,17301,18229,19417,21867,22684,23761,23612,23538,22387,21793,20197,17412,15147,13291,11360,9690,9393,9318,8650,9690,10284,11026,12845,13959,14293,13365,12845,11732,10135,8353,6942,5383,3675,3824,2636,2116,1819,1744,2413,3824,5346,5680,6905,7239,7870,7648,7759,7388,6348,6200,5977,4937,4715,4232,5160,5754,7908,9467,11695,14108,15630,17449,18377,19083,18118,17264,16670,14219,12103,10172,8353,7499,5940,5940,5346,6274,7239,8724,10506,11917,12771,13365,14034,14553,13959,14182,14034,13105,12697,12289,11880,11175,11249,10841,11175,11026,11620,11620,12400,12251,12474,11732,11360,10544,9393,9504,9096,9912,11435,12474,13885,14516,15667,16150,15779,16410,16447,16670,16484,16818,17041,17152,18118,17412,17709,16818,16447,16484,15333,15667,14405,14145,13996,13811,13180,12994,12251,12214,11992,11026,9467,7870,7091,7202,7388,8539,8873,9059,10321,10395,9950,9430,9393,7759,7276,6608,6163,4937,4603,5606,5457,6905,7648,8687,11398,12511,13737,14776,16447,16298,15222,14553,14962,14479,12957,11360,10284,7462,7796,6497,6868,7908,8910,9541,11063,11954,11992,11954,13254,14145,12845,12103,10209,8279,6460,5828,4640,4343,4529,5531,6460,8205,9950,10766,12734,13068,13105,12326,12400,11286,10618,10692,9541,9281,9059,9764,9096,9467,10172,11360,13068,15370,16967,18526,19751,20939,19900,19863,17635,14813,12548,10432,8539,6163,6534,5643,5643,6088,6905,7648,8613,10135,10952,12103,13365,13922,13922,14182,13922,12957,12660,11843,10952,10878,11323,11472,11843,12660,13440,13402,12400,12400,13105,12511,12660,11732,11323,11695,11398,11880,11657,13217,14479,15407,17486,18118,18897,19751,20494,20308,20605,21682,21533,21905,21682,21682,21273,21162,21162,19640,19343,19083,18118,17932,17598,17226,16076,15853,14999,14702,14108,13662,13254,12474,12771,12140,12177,12808,12214,12214,12326,12400,11880,11806,11472,10432,10024,9207,9356,8130,8687,8427,7759,9430,10692,12029,13440,15036,16818,17041,18526,18192,18043,16929,16001,13959,12400,10989,8836,7462,7314,6274,5791,5791,7351,8019,9318,11435,11732,12177,12177,12660,10692,9987,8130,6088,4381,3749,2970,2710,3824,5123,5680,6868,7759,9096,9987,10878,10841,10581,10804,9875,8576,7908,7759,7462,7462,7573,6720,7573,7351,7648,9021,10395,12289,13105,14850,15073,14813,13440,12177,9653,7091,4715,2264,445,148,0,445,334,1930,2264,3118,4640,5234,6720,7908,9021,8502,9318,8836,7165,7314,7091,6422,5903,6534,6831,6905,7759,8167,9096,9727,10024,9875,9987,10729,10432,8316,6571,6534,6422,6051,7759,7314,8427,9430,11026,12437,13885,14850,15370,16298,16744,16744,16373,16001,15519,14813,15519,15444,15073,15073,14665,14813,13848,13291,12400,11175,11583,10581,11138,10804,11657,10915,11101,11620,11175,11360,10692,10544,10024,10321,10915,11026,10766,10692,9727,9393,8910,8353,7314,7611,6422,7128,7314,8019,8502,9170,11138,11360,11657,12214,12400,12214,11360,10544,8205,6868,4900,4046,3675,2227,2264,1707,2339,2636,3527,4752,6237,7276,8205,8613,9021,8130,7611,7908,7462,5828,5717,5457,5160,6163,6794,8762,10247,13068,14442,15816,17152,17932,18452,19566,20122,19009,18266,17672,16076,16113,15667,16521,17301,18452,19528,20382,22313,23835,24875,25766,26286,25766,24726,24281,21905,20122,17969,15259,13291,11472,10952,9875,10284,10952,11880,14108,15779,16707,17561,18823,19825,19009,19380,18563,17783,16261,15890,14516,13291,13811,13068,13402,13699,14553,14293,14442,15519,15296,15333,15444,15519,14368,14590,14739,14219,14256,14553,14553,15407,16707,18192,18674,20494,21570,21830,22981,23204,23204,22090,23204,22907,22907,23241,23055,23204,22796,23204,22684,21942,22202,21310,19603,18340,18526,18897,19454,20679,20716,21459,21830,21570,21348,21199,21088,20754,21830,21756,22573,23909,23909,23427,22202,21645,20085,19788,19640,20419,20308,20976,21793,22127,22981,23872,24578,25172,25060,25469,24503,24169,23241,21273,19788,17672,15964,13365,12660,10989,9987,11026,10804,11732,12251,13551,14442,15110,16707,16373,15779,14850,13996,12586,11360,10432,9318,9021,9281,9950,11398,12845,15556,16744,19083,20679,21088,21162,21051,20419,19306,19009,17858,17264,16855,17672,18118,19083,20976,21162,21905,23612,25023,26211,26731,27882,28030,27808,27399,25617,23909,21013,19268,16410,15296,14145,12808,13105,13811,15296,17524,19863,21496,22053,23055,23798,23612,23352,23055,22164,21310,20828,19603,19343,19268,18786,18340,18489,19343,19120,19566,20754,21533,21496,21496,21496,20160,19640,18637,17932,16187,14776,15296,14999,16484,17189,18563,19454,20457,20976,21459,21793,21051,20494,20605,20197,20457,20531,20531,19566,19046,19454,18823,19046,18563,18266,17783,18118,17561,17412,17858,18080,17783,16855,17524,17895,17561,18637,17821,17412,16484,16521,16187,16187,16744,16224,15890,15816,14999,14368,14256,14219,13291,14405,14850,14813,16076,16410,17635,17561,18415,18712,18340,17672,16447,15296,14071,12660,10544,8539,8130,6608,6645,6645,7388,7945,9021,10618,10729,11398,12140,12437,11992,11954,11249,9653,8502,6831,6014,4900,4975,4900,5197,7276,8799,10284,11546,13514,14071,14405,14665,13737,12400,11546,11249,11954,10618,11249,10135,10284,11063,11657,13625,14702,16447,17338,18971,19788,20085,20382,21236,21162,19120,17412,15333,12808,11880,10618,10692,11286,12734,13699,15147,17189,18637,20642,21533,21756,22053,22499,23427,22536,22536,20679,19343,17338,16632,16410,15927,16744,17189,18118,18266,19120,20160,19788,20605,19900,19566,19268,17895,17635,16001,17375,17338,17969,19009,19825,20457,20754,22350,22870,23315,23204,22721,23315,23093,22796,22090,21533,21088,19603,19306,18563,17932,17932,17672,17709,17226,17858,17338,17524,17672,18155,18006,18192,19009,18080,18712,18786,18563,17969,17078,16781,15630,16187,16670,16224,16447,16187,16632,15444,15667,15110,14739,14850,14813,16187,16187,17709,18489,18934,19974,20048,19343,19863,18860,17709,16558,15853,14813,13959,13068,12883,12326,12326,12548,12437,13662,14034,14219,15036,16298,16855,16447,16818,15927,14999,13105,11992,10247,8316,8762,8799,9690,11583,12623,13551,14368,16484,16261,17375,16744,15927,15073,13254,11657,9653,9504,9170,8464,9059,9133,9170,9987,11843,13365,13922,15147,14739,14702,14368,13848,12214,10989,9615,7351,5828,4603,3824,3267,3081,4195,4975,7685,10247,12883,14479,16484,17858,18118,18971,18377,17412,16818,15964,15296,14034,14293,13588,13180,14182,14516,15704,15667,16929,16744,16929,17041,17264,17078,16670,16670,16224,15890,15779,14776,15296,15073,15927,16744,17524,19343,20160,22053,22684,23241,22647,22313,20828,19268,18637,17635,17301,16632,16558,16632,16707,17561,16447,16707,16373,16929,16298,16967,17486,16818,17635,18192,18229,17264,15370,15816,14219,14776,13885,12994,13068,12214,12289,11435,11769,10469,10061,9615,8873,8502,8799,9393,9727,10135,11657,11695,12474,12289,12474,11843,11954,12140,10878,10247,9096,9578,9318,8799,7870,6348,6905,6831,8279,9393,10432,11620,12029,13143,12771,13143,12734,12177,11323,9356,9096,7314,6979,6534,6534,7611,7611,10024,9950,11620,12734,13402,14219,14776,15296,14293,13551,12177,11026,10321,8576,7945,7388,7425,8205,8242,10804,11546,13217,14293,14776,14145,13328,12511,10506,9653,7462,6125,4529,3935,3044,1447,1856,2116,3118,4678,7054,9690,11583,13699,14665,15073,15222,15890,17078,15482,15036,13440,12808,12289,11620,12177,11249,12103,11695,12400,13402,14108,14962,15964,15370,14739,14256,13996,12845,12289,11620,11472,10952,11657,12808,13996,16187,17783,19306,20828,22313,23055,23241,23649,22684,22499,21348,20828,20308,20122,21273,20494,20976,21013,20605,21385,22944,23315,22239,23167,22907,23538,24169,23947,24169,23761,24652,23761,22907,22647,21051,20122,19603,19268,18377,17412,17004,15927,16001,15222,15222,13959,14256,14665,14628,15073,15407,15593,15667,15853,16521,16521,15667,14739,13699,13143,12883,12029,10766,10804,9578,9950,10135,10284,10804,10989,12734,13105,13959,14702,14925,15333,15333,15816,14999,15407,14628,14145,13365,12808,12214,12251,12845,14145,14925,17338,18637,19380,20122,21088,21273,19863,19788,17524,16670,14665,15036,13922,14962,15779,16670,17486,18934,20197,21385,22239,22499,22090,22647,21793,21088,19120,17672,15964,13996,13699,11620,10804,10172,9281,9467,10766,13885,15370,17932,20085,21793,22721,22313,22313,20382,19863,18712,17746,16447,15593,14516,14256,13737,13848,12771,13551,13922,15370,15704,16224,16558,16373,16967,15964,15222,13440,12883,12289,12511,13848,13959,15482,16632,18340,19788,21533,22758,23798,25320,25617,25617,25506,24912,24986,23798,23501,22053,21199,21570,22053,23538,23352,25320,25283,26545,27139,27251,26694,26211,26842,25914,26174,26545,25766,26323,26174,26397,25729,24838,24466,23018,22758,22164,22090,21533,22350,22758,22461,23093,22239,22350,22796,22981,22090,22016,23204,22647,22870,22424,22573,20976,20345,19566,18415,17412,16558,16076,14145,11917,12511,11992,12771,13031,13514,14256,14219,15110,14962,15630,14813,14368,13699,12845,12400,11546,11583,10989,10581,11323,11657,12548,13514,15407,16113,17672,18526,18266,17783,17338,16335,15036,13996,13105,11732,12103,12029,13105,14108,15667,17264,17524,19900,20716,21793,21756,21459,20085,18897,18340,16261,14739,13402,12474,12400,12400,13514,13551,15259,17078,18637,21013,22944,24466,24838,25172,24838,24206,23464,21905,20716,17635,17264,15853,14665,14071,13551,13440,13440,14479,15036,15370,15556,15964,16335,16001,15407,13996,12957,12697,11175,11286,10952,11583,12474,13402,15222,15816,17672,18749,20048,20605,20754,20345,19491,19268,17486,16744,15482,14813,14776,14776,15147,15630,16224,17226,17375,17672,19009,19937,19380,20085,20122,18934,19046,18563,19231,17486,17486,16967,16855,16558,16484,16335,14776,13254,12586,12883,13514,13068,13217,12994,13885,13625,13625,14219,13217,14293,14999,16076,17709,18674,18526,16744,16335,15147,13885,12437,11286,11063,10581,11695,11398,10989,10841,10952,10692,10581,10692,11286,11806,12140,12103,11843,10247,9578,7982,7054,5940,4678,4826,4826,6051,5903,7054,8056,8762,9838,9727,10432,9690,9653,8316,6757,5977,4009,3527,2784,3081,3527,3861,5903,7017,9578,11360};
   float32 spectraTable[SPECTRA_LENGTH];
   Uint16 freqMax[SPECTRA_LENGTH];
   Uint16 freqOver[SPECTRA_LENGTH];
   float32 peakList[50];

void adcLogic();
void processLSpike3();

main()
{
   int i;
     
// Clear out buffers for results.
   for (i = 0; i < SPECTRA_LENGTH; i++) {
     spectraTable[i] = 0;
   }
   for (i = 0; i < 50; i++) {
   	 peakList[i] = 0;
   }
   for (i = 0; i < SPECTRA_LENGTH; i++) {
   	 freqMax[i] = 0;
   }
   for (i = 0; i < SPECTRA_LENGTH; i++) {
   	 freqOver[i] = 0;
   }
	
// Step 1. Initialize System Control:
   InitSysCtrl();

// Specific clock setting for this example:
   EALLOW;
   SysCtrlRegs.HISPCP.all = ADC_MODCLK;	// HSPCLK = SYSCLKOUT/ADC_MODCLK
   EDIS;

// Step 2. Initialize GPIO:
   EALLOW;
   GpioCtrlRegs.GPBMUX1.bit.GPIO34 = 0;    // GPIO pin
   GpioCtrlRegs.GPBDIR.bit.GPIO34 = 1;     // Output pin
   EDIS;

// Step 3. Clear all interrupts and initialize PIE vector table:
// Disable CPU interrupts
   DINT;

// Initialize the PIE control registers to their default state.
   InitPieCtrl();

// Disable CPU interrupts and clear all CPU interrupt flags:
   IER = 0x0000;
   IFR = 0x0000;

// Initialize the PIE vector table with pointers to the shell Interrupt
// Service Routines (ISR).
   InitPieVectTable();
   EALLOW;  // This is needed to write to EALLOW protected registers
   EDIS;    // This is needed to disable write to EALLOW protected registers

// Step 4. Initialize the Device Peripheral. 
   InitCpuTimers();   // For this example, only initialize the Cpu Timers
#if (CPU_FRQ_150MHZ)
// Configure CPU-Timer 0 to interrupt every 500 milliseconds:
// 150MHz CPU Freq, 50 millisecond Period (in uSeconds)
// 4/15 Disabled timer interrupts   ConfigCpuTimer(&CpuTimer0, 150, 500000);
#endif
#if (CPU_FRQ_100MHZ)
// Configure CPU-Timer 0 to interrupt every 500 milliseconds:
// 100MHz CPU Freq, 50 millisecond Period (in uSeconds)
   ConfigCpuTimer(&CpuTimer0, 100, 500000);
#endif

   CpuTimer0Regs.TCR.all = 0x4001; // Use write-only instruction to set TSS bit = 0

// Enable CPU INT1 which is connected to CPU-Timer 0:
// 4/15 disabled unused timer interrupt   IER |= M_INT1;

// Enable TINT0 in the PIE: Group 1 interrupt 7
   PieCtrlRegs.PIEIER1.bit.INTx7 = 1;

// Enable global Interrupts and higher priority real-time debug events:
   EINT;   // Enable Global interrupt INTM
   ERTM;   // Enable Global realtime interrupt DBGM
// WDS: END

// Step 4. Initialize all the Device Peripherals:
   InitAdc();         // For this example, init the ADC

// Specific ADC setup for this example:
   AdcRegs.ADCTRL1.bit.ACQ_PS = ADC_SHCLK;  // Sequential mode: Sample rate   = 1/[(2+ACQ_PS)*ADC clock in ns]
                        //                     = 1/(3*40ns) =8.3MHz (for 150 MHz SYSCLKOUT)
					    //                     = 1/(3*80ns) =4.17MHz (for 100 MHz SYSCLKOUT)
					    // If Simultaneous mode enabled: Sample rate = 1/[(3+ACQ_PS)*ADC clock in ns]
   AdcRegs.ADCTRL3.bit.ADCCLKPS = ADC_CKPS;
   AdcRegs.ADCTRL1.bit.SEQ_CASC = 1;        // 1  Cascaded mode
   AdcRegs.ADCCHSELSEQ1.bit.CONV00 = 0x0;
   AdcRegs.ADCTRL1.bit.CONT_RUN = 1;       // Setup continuous run

   AdcRegs.ADCTRL1.bit.SEQ_OVRD = 1;       // Enable Sequencer override feature
   AdcRegs.ADCCHSELSEQ1.all = 0x0;         // Initialize all ADC channel selects to A0
   AdcRegs.ADCCHSELSEQ2.all = 0x0;
   AdcRegs.ADCCHSELSEQ3.all = 0x0;
   AdcRegs.ADCCHSELSEQ4.all = 0x0;
   AdcRegs.ADCMAXCONV.bit.MAX_CONV1 = 0x7;  // convert and store in 8 results registers


	// Step 5. User specific code, enable interrupts:
   
	// Start SEQ1
	AdcRegs.ADCTRL2.all = 0x2000;

//	adcLogic();
	processLSpike3();
   for (;;) {}
}

// adcLogic moved out to a function so it could be called from interrupt.
void adcLogic() {
   Uint16 array_index;
   Uint16 dataAq_loop;
   
     // Initalize the array index.  This points to the current
     // location within the SampleTable
     array_index = 0;
	for (dataAq_loop = 0; dataAq_loop < 16; dataAq_loop++)
	{
	     for (array_index=0; array_index < 128; array_index++)
	     {
	
	       SampleTable[array_index + (dataAq_loop * 128)]= ( (AdcRegs.ADCRESULT0)>>4);
	       DELAY_US(10000);
		}
	}
    GpioDataRegs.GPBCLEAR.bit.GPIO34 = 1;  // Clear GPIO34 for monitoring  -optional
}
